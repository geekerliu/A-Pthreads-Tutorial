# 并发性

## 并发的好处

在许多情况下多线程可以非常简单的写出优雅并且高效的代码。
下面的这些种类的问题非常适合使用多线程。

阻塞IO：一个程序要处理一系列的IO操作有下面三种选择。串行的处理IO请求，
一个完成了才能进行下一个。也可以使用异步IO，处理所有复杂的异步信号，
polling或者selects。或者使用同步IO，每一个IO请求都单独创建一个线程来处理。
在这种情况下，多线程可以明显的提高性能降低代码复杂度。

多处理器：如果你使用的线程库支持多处理器，你可以通过在每一个处理
器上运行线程来显著的提高性能。这在你的程序需要大量计算的时候非常有用。

用户界面：将耗时的操作放在线程中来执行，这样UI界面可以继续和用户交互。

服务：服务于多个客户端的服务器可以通过适当使用并发作出反应更灵敏。
这在传统上一直通过使用fork()系统调用来实现。然而，在某些情况下，
尤其是对于大型高速缓存打交道时，线程可以帮助提高内存的利用率。
甚至代替fork()处理并发操作，在某些fork()不适用的情况下。

但是这里也有一些问题，因为多个线程分享相同的地址空间。
最大的问题就是数据竞争。考虑一下下面这个代码：

```
THREAD 1                THREAD 2
a = data;               b = data;
a++;                    b--;
data = a;               data = b;
```
如果代码是串行的执行(先执行THREAD 1，然后执行THREAD 2)，那么这里没有问题。
但是线程执行的顺序是完全随机的，所以看一下下面这种情况：

```
THREAD 1                THREAD 2
a = data;
                        b = data;
a++;
                        b--;
data = a;
                        data = b;
[data = data - 1!!!!!!!]
```
数据最后可能是+1，0，-1，这里没有办法知道是哪一个结果，因为这是完全不确定的。

解决办法是提供一种功能，当数据正在被一个线程访问时，
其它线程则阻塞。pthreads使用mutex来实现这个功能。